# frozen_string_literal: true

require 'spec_helper'

describe 'applocker::compare_rules' do
  # please note that these tests are examples only
  # you will need to replace the params and return value
  # with your expectations
  it { is_expected.to run.with_params({'Version' => '1', 'RuleCollection' => [{'Type' => 'Appx', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3ae31537-34e8-c52c-0363-df50388fea30', 'Name' => 'Packaged app MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington', 'C=US, ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'cc1cc505-ce9a-6dd7-4d73-9d0204f9735d', 'Name' => 'Packaged app MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}], 'Exceptions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Louis, O=Poodle, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '3.0.0.0'}]}, {'PublisherName' => 'CN=doge, O=coin, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Dll', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '81baaabe-4266-ffd4-ca79-6c66a2ea3e98', 'Name' => 'DLL %WINDIR/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*}]}]', 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\\'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}]}]}, {'Id' => 'f9efadbf-0255-9e65-dbcf-11fcd8cb27d4', 'Name' => 'DLL %PROGRAMFILES/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}]}]}]}, {'Type' => 'Exe', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '93246af9-225e-01ab-a22b-2ea6defbac20', 'Name' => 'Exec %%PROGRAMFILES/%', 'Description' => 'Allow all users to run apps in programfiles', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => 'a8cdb667-143d-127e-32a9-b9e641c19f39', 'Name' => 'Exec %OSDRIVE/temp/%', 'Description' => 'Allow all users to run apps in osdrive temp', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\temp\doge\*'}]}]}, {'Id' => 'd2b6b159-3d42-470c-4108-2a1d43be39cc', 'Name' => 'Exec %OSDRIVE/CHOCO/%', 'Description' => 'Allow all users to run apps in osdrive choco', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\CHOCO\*'}]}]}, {'Id' => 'fd042c8a-c663-028d-8e61-7adf35f86da0', 'Name' => 'Exec %windir/%', 'Description' => 'Allow all users to run apps in windir', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}]}]}]}, {'Type' => 'Msi', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3088d67f-075c-4c08-c773-6bc75fd74381', 'Name' => 'MSI rule MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'd70f545d-8d7b-a801-6e4b-ce152ba570f2', 'Name' => 'MSI rule MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Script', 'EnforcementMode' => 'Enabled', 'FilePathRule' => [{'Id' => '03dfa177-8b1a-6ef2-a6b2-07cbedc9a990', 'Name' => 'Script %PROGRAMFILES/%', 'Description' => 'Allow scripts in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => '35ff3c00-3ede-6cba-13f4-c9de04a72a79', 'Name' => 'Script %WINDIR/%', 'Description' => 'Allow scripts in the windir directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\Com\dmp\*'}, {'Path' => '%SYSTEM32%\FxsTmp\*'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\spool\PRINTERS\*'}, {'Path' => '%SYSTEM32%\spool\SERVERS\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Registration\CRMLog\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}, {'Path' => '%WINDIR%\tracing\*'}]}]}], 'FileHashRule' => [{'Id' => '778e4183-dec5-42df-e395-87173ace089d', 'Name' => 'Script powershell hash', 'Description' => 'random test powershell script', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FileHashCondition' => [{'FileHash' => [{'Type' => 'SHA256', 'Data' => '0x2057696D8662313670D36C3A3C8009FB038C8732C40C65275F158F63AAAD1629', 'SourceFileName' => 'powerfulshell.ps1', 'SourceFileLength' => '20'}]}]}]}]}]}, {'Version' => '1', 'RuleCollection' => [{'Type' => 'Appx', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3ae31537-34e8-c52c-0363-df50388fea30', 'Name' => 'Packaged app MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington', 'C=US, ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'cc1cc505-ce9a-6dd7-4d73-9d0204f9735d', 'Name' => 'Packaged app MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}], 'Exceptions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Louis, O=Poodle, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '3.0.0.0'}]}, {'PublisherName' => 'CN=doge, O=coin, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Dll', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '81baaabe-4266-ffd4-ca79-6c66a2ea3e98', 'Name' => 'DLL %WINDIR/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*}]}]', 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\\'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}]}]}, {'Id' => 'f9efadbf-0255-9e65-dbcf-11fcd8cb27d4', 'Name' => 'DLL %PROGRAMFILES/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}]}]}]}, {'Type' => 'Exe', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '93246af9-225e-01ab-a22b-2ea6defbac20', 'Name' => 'Exec %%PROGRAMFILES/%', 'Description' => 'Allow all users to run apps in programfiles', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => 'a8cdb667-143d-127e-32a9-b9e641c19f39', 'Name' => 'Exec %OSDRIVE/temp/%', 'Description' => 'Allow all users to run apps in osdrive temp', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\temp\doge\*'}]}]}, {'Id' => 'd2b6b159-3d42-470c-4108-2a1d43be39cc', 'Name' => 'Exec %OSDRIVE/CHOCO/%', 'Description' => 'Allow all users to run apps in osdrive choco', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\CHOCO\*'}]}]}, {'Id' => 'fd042c8a-c663-028d-8e61-7adf35f86da0', 'Name' => 'Exec %windir/%', 'Description' => 'Allow all users to run apps in windir', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}]}]}]}, {'Type' => 'Msi', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3088d67f-075c-4c08-c773-6bc75fd74381', 'Name' => 'MSI rule MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'd70f545d-8d7b-a801-6e4b-ce152ba570f2', 'Name' => 'MSI rule MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Script', 'EnforcementMode' => 'Enabled', 'FilePathRule' => [{'Id' => '03dfa177-8b1a-6ef2-a6b2-07cbedc9a990', 'Name' => 'Script %PROGRAMFILES/%', 'Description' => 'Allow scripts in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => '35ff3c00-3ede-6cba-13f4-c9de04a72a79', 'Name' => 'Script %WINDIR/%', 'Description' => 'Allow scripts in the windir directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\Com\dmp\*'}, {'Path' => '%SYSTEM32%\FxsTmp\*'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\spool\PRINTERS\*'}, {'Path' => '%SYSTEM32%\spool\SERVERS\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Registration\CRMLog\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}, {'Path' => '%WINDIR%\tracing\*'}]}]}], 'FileHashRule' => [{'Id' => '778e4183-dec5-42df-e395-87173ace089d', 'Name' => 'Script powershell hash', 'Description' => 'random test powershell script', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FileHashCondition' => [{'FileHash' => [{'Type' => 'SHA256', 'Data' => '0x2057696D8662313670D36C3A3C8009FB038C8732C40C65275F158F63AAAD1629', 'SourceFileName' => 'powerfulshell.ps1', 'SourceFileLength' => '20'}]}]}]}]}]}).and_return({ 'Result' => true }) }
  it { is_expected.to run.with_params({'Version' => '1'}, {'Version' => '1', 'RuleCollection' => [{'Type' => 'Appx', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3ae31537-34e8-c52c-0363-df50388fea30', 'Name' => 'Packaged app MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington', 'C=US, ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'cc1cc505-ce9a-6dd7-4d73-9d0204f9735d', 'Name' => 'Packaged app MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}], 'Exceptions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Louis, O=Poodle, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '3.0.0.0'}]}, {'PublisherName' => 'CN=doge, O=coin, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Dll', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '81baaabe-4266-ffd4-ca79-6c66a2ea3e98', 'Name' => 'DLL %WINDIR/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*}]}]', 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\\'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}]}]}, {'Id' => 'f9efadbf-0255-9e65-dbcf-11fcd8cb27d4', 'Name' => 'DLL %PROGRAMFILES/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}]}]}]}, {'Type' => 'Exe', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '93246af9-225e-01ab-a22b-2ea6defbac20', 'Name' => 'Exec %%PROGRAMFILES/%', 'Description' => 'Allow all users to run apps in programfiles', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => 'a8cdb667-143d-127e-32a9-b9e641c19f39', 'Name' => 'Exec %OSDRIVE/temp/%', 'Description' => 'Allow all users to run apps in osdrive temp', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\temp\doge\*'}]}]}, {'Id' => 'd2b6b159-3d42-470c-4108-2a1d43be39cc', 'Name' => 'Exec %OSDRIVE/CHOCO/%', 'Description' => 'Allow all users to run apps in osdrive choco', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\CHOCO\*'}]}]}, {'Id' => 'fd042c8a-c663-028d-8e61-7adf35f86da0', 'Name' => 'Exec %windir/%', 'Description' => 'Allow all users to run apps in windir', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}]}]}]}, {'Type' => 'Msi', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3088d67f-075c-4c08-c773-6bc75fd74381', 'Name' => 'MSI rule MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'd70f545d-8d7b-a801-6e4b-ce152ba570f2', 'Name' => 'MSI rule MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Script', 'EnforcementMode' => 'Enabled', 'FilePathRule' => [{'Id' => '03dfa177-8b1a-6ef2-a6b2-07cbedc9a990', 'Name' => 'Script %PROGRAMFILES/%', 'Description' => 'Allow scripts in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => '35ff3c00-3ede-6cba-13f4-c9de04a72a79', 'Name' => 'Script %WINDIR/%', 'Description' => 'Allow scripts in the windir directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\Com\dmp\*'}, {'Path' => '%SYSTEM32%\FxsTmp\*'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\spool\PRINTERS\*'}, {'Path' => '%SYSTEM32%\spool\SERVERS\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Registration\CRMLog\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}, {'Path' => '%WINDIR%\tracing\*'}]}]}], 'FileHashRule' => [{'Id' => '778e4183-dec5-42df-e395-87173ace089d', 'Name' => 'Script powershell hash', 'Description' => 'random test powershell script', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FileHashCondition' => [{'FileHash' => [{'Type' => 'SHA256', 'Data' => '0x2057696D8662313670D36C3A3C8009FB038C8732C40C65275F158F63AAAD1629', 'SourceFileName' => 'powerfulshell.ps1', 'SourceFileLength' => '20'}]}]}]}]}]}).and_return({ 'Result' => false }) }

  it { is_expected.to run.with_params({'Version' => '1', 'RuleCollection' => [{'Type' => 'Appx', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3ae31537-34e8-c52c-0363-df50388fea30', 'Name' => 'Packaged app MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington', 'C=US, ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'cc1cc505-ce9a-6dd7-4d73-9d0204f9735d', 'Name' => 'Packaged app MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}], 'Exceptions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Louis, O=Poodle, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '3.0.0.0'}]}, {'PublisherName' => 'CN=doge, O=coin, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Dll', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '81baaabe-4266-ffd4-ca79-6c66a2ea3e98', 'Name' => 'DLL %WINDIR/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*}]}]', 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\\'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}]}]}, {'Id' => 'f9efadbf-0255-9e65-dbcf-11fcd8cb27d4', 'Name' => 'DLL %PROGRAMFILES/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}]}]}]}, {'Type' => 'Exe', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '93246af9-225e-01ab-a22b-2ea6defbac20', 'Name' => 'Exec %%PROGRAMFILES/%', 'Description' => 'Allow all users to run apps in programfiles', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => 'a8cdb667-143d-127e-32a9-b9e641c19f39', 'Name' => 'Exec %OSDRIVE/temp/%', 'Description' => 'Allow all users to run apps in osdrive temp', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\temp\doge\*'}]}]}, {'Id' => 'd2b6b159-3d42-470c-4108-2a1d43be39cc', 'Name' => 'Exec %OSDRIVE/CHOCO/%', 'Description' => 'Allow all users to run apps in osdrive choco', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\CHOCO\*'}]}]}, {'Id' => 'fd042c8a-c663-028d-8e61-7adf35f86da0', 'Name' => 'Exec %windir/%', 'Description' => 'Allow all users to run apps in windir', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}]}]}]}, {'Type' => 'Msi', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3088d67f-075c-4c08-c773-6bc75fd74381', 'Name' => 'MSI rule MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmon1d, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'd70f545d-8d7b-a801-6e4b-ce152ba570f2', 'Name' => 'MSI rule MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Script', 'EnforcementMode' => 'Enabled', 'FilePathRule' => [{'Id' => '03dfa177-8b1a-6ef2-a6b2-07cbedc9a990', 'Name' => 'Script %PROGRAMFILES/%', 'Description' => 'Allow scripts in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => '35ff3c00-3ede-6cba-13f4-c9de04a72a79', 'Name' => 'Script %WINDIR/%', 'Description' => 'Allow scripts in the windir directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\Com\dmp\*'}, {'Path' => '%SYSTEM32%\FxsTmp\*'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\spool\PRINTERS\*'}, {'Path' => '%SYSTEM32%\spool\SERVERS\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Registration\CRMLog\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}, {'Path' => '%WINDIR%\tracing\*'}]}]}], 'FileHashRule' => [{'Id' => '778e4183-dec5-42df-e395-87173ace089d', 'Name' => 'Script powershell hash', 'Description' => 'random test powershell script', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FileHashCondition' => [{'FileHash' => [{'Type' => 'SHA256', 'Data' => '0x2057696D8662313670D36C3A3C8009FB038C8732C40C65275F158F63AAAD1629', 'SourceFileName' => 'powerfulshell.ps1', 'SourceFileLength' => '20'}]}]}]}]}]}, {'Version' => '1', 'RuleCollection' => [{'Type' => 'Appx', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3ae31537-34e8-c52c-0363-df50388fea30', 'Name' => 'Packaged app MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington', 'C=US, ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'cc1cc505-ce9a-6dd7-4d73-9d0204f9735d', 'Name' => 'Packaged app MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}], 'Exceptions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Louis, O=Poodle, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '3.0.0.0'}]}, {'PublisherName' => 'CN=doge, O=coin, C=AU', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Dll', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '81baaabe-4266-ffd4-ca79-6c66a2ea3e98', 'Name' => 'DLL %WINDIR/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*}]}]', 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\\'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}]}]}, {'Id' => 'f9efadbf-0255-9e65-dbcf-11fcd8cb27d4', 'Name' => 'DLL %PROGRAMFILES/%', 'Description' => 'Allow dll in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}]}]}]}, {'Type' => 'Exe', 'EnforcementMode' => 'AuditOnly', 'FilePathRule' => [{'Id' => '93246af9-225e-01ab-a22b-2ea6defbac20', 'Name' => 'Exec %%PROGRAMFILES/%', 'Description' => 'Allow all users to run apps in programfiles', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => 'a8cdb667-143d-127e-32a9-b9e641c19f39', 'Name' => 'Exec %OSDRIVE/temp/%', 'Description' => 'Allow all users to run apps in osdrive temp', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\temp\doge\*'}]}]}, {'Id' => 'd2b6b159-3d42-470c-4108-2a1d43be39cc', 'Name' => 'Exec %OSDRIVE/CHOCO/%', 'Description' => 'Allow all users to run apps in osdrive choco', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%OSDRIVE%\CHOCO\*'}]}]}, {'Id' => 'fd042c8a-c663-028d-8e61-7adf35f86da0', 'Name' => 'Exec %windir/%', 'Description' => 'Allow all users to run apps in windir', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}]}]}]}, {'Type' => 'Msi', 'EnforcementMode' => 'AuditOnly', 'FilePublisherRule' => [{'Id' => '3088d67f-075c-4c08-c773-6bc75fd74381', 'Name' => 'MSI rule MS corp windows', 'Description' => 'Allow Package app rule Microsoft corporation (Windows)', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}, {'Id' => 'd70f545d-8d7b-a801-6e4b-ce152ba570f2', 'Name' => 'MSI rule MS corp', 'Description' => 'Allow Package app rule Microsoft corporation', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePublisherCondition' => [{'PublisherName' => 'CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US', 'ProductName' => '*', 'BinaryName' => '*', 'BinaryVersionRange' => [{'LowSection' => '*', 'HighSection' => '*'}]}]}]}]}, {'Type' => 'Script', 'EnforcementMode' => 'Enabled', 'FilePathRule' => [{'Id' => '03dfa177-8b1a-6ef2-a6b2-07cbedc9a990', 'Name' => 'Script %PROGRAMFILES/%', 'Description' => 'Allow scripts in the programfiles directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%PROGRAMFILES%\*'}]}]}, {'Id' => '35ff3c00-3ede-6cba-13f4-c9de04a72a79', 'Name' => 'Script %WINDIR/%', 'Description' => 'Allow scripts in the windir directory', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FilePathCondition' => [{'Path' => '%WINDIR%\*'}]}], 'Exceptions' => [{'FilePathCondition' => [{'Path' => '%SYSTEM32%\Com\dmp\*'}, {'Path' => '%SYSTEM32%\FxsTmp\*'}, {'Path' => '%System32%\Microsoft\Crypto\RSA\MachineKeys\*'}, {'Path' => '%SYSTEM32%\spool\drivers\color\*'}, {'Path' => '%SYSTEM32%\spool\PRINTERS\*'}, {'Path' => '%SYSTEM32%\spool\SERVERS\*'}, {'Path' => '%SYSTEM32%\Tasks\*'}, {'Path' => '%WINDIR%\Registration\CRMLog\*'}, {'Path' => '%WINDIR%\Tasks\*'}, {'Path' => '%WINDIR%\Temp\*'}, {'Path' => '%WINDIR%\tracing\*'}]}]}], 'FileHashRule' => [{'Id' => '778e4183-dec5-42df-e395-87173ace089d', 'Name' => 'Script powershell hash', 'Description' => 'random test powershell script', 'UserOrGroupSid' => 'S-1-1-0', 'Action' => 'Allow', 'Conditions' => [{'FileHashCondition' => [{'FileHash' => [{'Type' => 'SHA256', 'Data' => '0x2057696D8662313670D36C3A3C8009FB038C8732C40C65275F158F63AAAD1629', 'SourceFileName' => 'powerfulshell.ps1', 'SourceFileLength' => '20'}]}]}]}]}]}).and_return({ 'Result' => false, 'failing_rule' => 'Msi' }) }
end
