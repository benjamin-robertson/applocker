# frozen_string_literal: true

require 'spec_helper'

describe 'applocker' do
  on_supported_os.each do |os, os_facts|
    context "on #{os}" do
      let(:facts) { os_facts }

      context 'with applocker fact' do
        let(:facts) do
          super().merge({ 'applocker_rules' => '<AppLockerPolicy Version="1"><RuleCollection Type="Appx" EnforcementMode="AuditOnly"><FilePublisherRule Id="0d49c961-d558-f11f-2c4e-0f08c617e0ba" Name="Packaged app MS corp" Description="Allow Package app rule Microsoft corporation" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePublisherCondition PublisherName="CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US" ProductName="*" BinaryName="*"><BinaryVersionRange LowSection="*" HighSection="*" /></FilePublisherCondition></Conditions><Exceptions><FilePublisherCondition PublisherName="CN=Louis, O=Poodle, C=AU" ProductName="*" BinaryName="*"><BinaryVersionRange LowSection="*" HighSection="3.0.0.0" /></FilePublisherCondition><FilePublisherCondition PublisherName="CN=doge, O=coin, C=AU" ProductName="*" BinaryName="*"><BinaryVersionRange LowSection="*" HighSection="*" /></FilePublisherCondition></Exceptions></FilePublisherRule><FilePublisherRule Id="5d22aa9a-93dc-14b2-9f29-53b96866163d" Name="Packaged app MS corp windows" Description="Allow Package app rule Microsoft corporation (Windows)" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePublisherCondition PublisherName="CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US" ProductName="*" BinaryName="*"><BinaryVersionRange LowSection="*" HighSection="*" /></FilePublisherCondition></Conditions></FilePublisherRule></RuleCollection><RuleCollection Type="Dll" EnforcementMode="AuditOnly"><FilePathRule Id="818e6ea9-0b5f-f519-10ff-b2a5122fde61" Name="DLL %PROGRAMFILES/%" Description="Allow dll in the programfiles directory" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%PROGRAMFILES%\*" /></Conditions></FilePathRule><FilePathRule Id="f828c80a-616a-f7fa-3775-c2248150e11d" Name="DLL %WINDIR/%" Description="Allow dll in the programfiles directory" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%WINDIR%\*" /></Conditions><Exceptions><FilePathCondition Path="%SYSTEM32%\spool\drivers\color\*" /><FilePathCondition Path="%SYSTEM32%\Tasks\*" /><FilePathCondition Path="%WINDIR%\Tasks\*" /><FilePathCondition Path="%WINDIR%\Temp\" /><FilePathCondition Path="%System32%\Microsoft\Crypto\RSA\MachineKeys\*" /></Exceptions></FilePathRule></RuleCollection><RuleCollection Type="Exe" EnforcementMode="AuditOnly"><FilePathRule Id="5786c265-cc04-8380-bb28-b5becdee3736" Name="Exec %%PROGRAMFILES/%" Description="Allow all users to run apps in programfiles" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%PROGRAMFILES%\*" /></Conditions></FilePathRule><FilePathRule Id="9f9161d7-80d8-a526-5088-766f8409f878" Name="Exec %OSDRIVE/temp/%" Description="Allow all users to run apps in osdrive temp" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%OSDRIVE%\temp\doge\*" /></Conditions></FilePathRule><FilePathRule Id="aa8ce19a-f606-2b5d-2696-d35256d13c0b" Name="Exec %windir/%" Description="Allow all users to run apps in windir" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%WINDIR%\*" /></Conditions><Exceptions><FilePathCondition Path="%System32%\Microsoft\Crypto\RSA\MachineKeys\*" /><FilePathCondition Path="%SYSTEM32%\spool\drivers\color\*" /><FilePathCondition Path="%SYSTEM32%\Tasks\*" /><FilePathCondition Path="%WINDIR%\Tasks\*" /><FilePathCondition Path="%WINDIR%\Temp\*" /></Exceptions></FilePathRule><FilePathRule Id="f29fbb37-713d-971c-bd52-6169b3e969bf" Name="Exec %OSDRIVE/CHOCO/%" Description="Allow all users to run apps in osdrive choco" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%OSDRIVE%\CHOCO\*" /></Conditions></FilePathRule></RuleCollection><RuleCollection Type="Msi" EnforcementMode="AuditOnly"><FilePublisherRule Id="03a1ac34-3dae-0a74-5cb8-0f54ac4c9b8a" Name="MSI rule MS corp windows" Description="Allow Package app rule Microsoft corporation (Windows)" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePublisherCondition PublisherName="CN=Microsoft Windows, O=Microsoft Corporation, L=Redmond, S=Washington, C=US" ProductName="*" BinaryName="*"><BinaryVersionRange LowSection="*" HighSection="*" /></FilePublisherCondition></Conditions></FilePublisherRule><FilePublisherRule Id="eb6d6296-cb9a-8b62-4f38-c1c41faa988b" Name="MSI rule MS corp" Description="Allow Package app rule Microsoft corporation" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePublisherCondition PublisherName="CN=Microsoft Corporation, O=Microsoft Corporation, L=Redmond, S=Washington, C=US" ProductName="*" BinaryName="*"><BinaryVersionRange LowSection="*" HighSection="*" /></FilePublisherCondition></Conditions></FilePublisherRule></RuleCollection><RuleCollection Type="Script" EnforcementMode="Enabled"><FilePathRule Id="6f823c06-ffe1-94c7-0a67-fd02f00b69e1" Name="Script %PROGRAMFILES/%" Description="Allow scripts in the programfiles directory" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%PROGRAMFILES%\*" /></Conditions></FilePathRule><FilePathRule Id="b848e5b3-8a26-eae5-8ba6-d1c73b06e592" Name="Script %WINDIR/%" Description="Allow scripts in the windir directory" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FilePathCondition Path="%WINDIR%\*" /></Conditions><Exceptions><FilePathCondition Path="%SYSTEM32%\Com\dmp\*" /><FilePathCondition Path="%SYSTEM32%\FxsTmp\*" /><FilePathCondition Path="%System32%\Microsoft\Crypto\RSA\MachineKeys\*" /><FilePathCondition Path="%SYSTEM32%\spool\drivers\color\*" /><FilePathCondition Path="%SYSTEM32%\spool\PRINTERS\*" /><FilePathCondition Path="%SYSTEM32%\spool\SERVERS\*" /><FilePathCondition Path="%SYSTEM32%\Tasks\*" /><FilePathCondition Path="%WINDIR%\Registration\CRMLog\*" /><FilePathCondition Path="%WINDIR%\Tasks\*" /><FilePathCondition Path="%WINDIR%\Temp\*" /><FilePathCondition Path="%WINDIR%\tracing\*" /></Exceptions></FilePathRule><FileHashRule Id="542f04da-a34c-d776-562b-7b35b627f1b9" Name="Script powershell hash" Description="random test powershell script" UserOrGroupSid="S-1-1-0" Action="Allow"><Conditions><FileHashCondition><FileHash Type="SHA256" Data="0x2057696D8662313670D36C3A3C8009FB038C8732C40C65275F158F63AAAD1629" SourceFileName="powerfulshell.ps1" SourceFileLength="20" /></FileHashCondition></Conditions></FileHashRule></RuleCollection></AppLockerPolicy>' })
        end

        it { is_expected.to compile }
      end
    end
  end
end
